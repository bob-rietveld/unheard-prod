# fn-2-phase-2-chat-interface-agent.6 Decision log markdown generation + Git commit

## Description
Generate decision log markdown file from config, commit to Git, and update existing Convex decisions table.

**Size:** M
**Files:**
- `src-tauri/src/commands/decisions.rs` (new)
- `src/lib/decision-generator.ts` (new - markdown template)
- `convex/decisions.ts` (update - new mutation)
- `src/services/decisions.ts` (new - TanStack Query hooks)

## Approach

**Flow**:
1. Config complete → Call `generateDecisionLog(config, template)`
2. Generate markdown with YAML frontmatter (see epic spec data model)
3. Create filename: `YYYY-MM-DD-{slug}.md` (slug from decision title)
4. Write via Tauri command: `create_decision_log(content, filename)`
5. Rust: Write to `/decisions`, Git commit (reuse `git_auto_commit` from Phase 1)
6. Frontend: Update Convex `decisions` table via `api.decisions.updateWithLog()`
7. Return decision ID + file path to frontend

**Filename Generation**:
- Sanitize title: lowercase, replace spaces with hyphens, remove special chars
- Prefix with ISO date: `2026-02-04-investor-evaluation.md`
- Check for duplicates: append `-2` if exists (reuse Phase 1 pattern)

**Markdown Template**:
```markdown
---
id: {generated-id}
title: {user-provided-title}
category: {template-category}
template: {template-slug}
status: ready
created: {iso-timestamp}
---

# {Title}

## Context
{config.context or "No context provided"}

## Configuration
{key-value pairs from config}

## Experiment Plan
- Personas: {config.persona_count} {config.persona_types}
- Generated from: {list of context files}

## Results
(To be filled after experiment runs)

## Decision
(To be made after reviewing results)

---
Auto-generated by Unheard v2 | Phase 2
```

**Reuse Git Command** (from Phase 1):
- Call existing `git_auto_commit` with files: `["decisions/{filename}"]`
- Commit message: `"Create decision: {title}"`

**Convex Schema Update** (CRITICAL - backward compatible):
- EXTEND existing `decisions` table (do NOT replace)
- Add new optional fields: `templateId`, `configData`, `markdownFilePath`, `updatedAt`
- Add new status values to existing enum: 'ready', 'running', 'completed'
- Preserve existing status values: 'draft', 'analyzing', 'decided'
- Add new index: `by_template` on `templateId`

## Key Context

**Backward Compatible Migration** (from review):
- Existing decisions have status: 'draft' | 'analyzing' | 'decided'
- New decisions created in Phase 2 use status: 'ready' | 'running' | 'completed'
- All new fields are optional, so old records remain valid
- New mutations check field existence before accessing

**Error Handling**:
- If Git commit fails: Log error, save to Convex with status='draft', show warning to user
- If Convex fails: Retry with exponential backoff (3 attempts), fallback to localStorage queue

## References

- Git command: Phase 1 spec (`fn-1`, task 5) - `git_auto_commit`
- Markdown format: Epic spec data model section
- Existing schema: `convex/schema.ts:13-26` (decisions table)
- Task 5: Config data from wizard
## Approach

**Flow**:
1. Config complete → Call `generateDecisionLog(config, template)`
2. Generate markdown with YAML frontmatter (see epic spec data model)
3. Create filename: `YYYY-MM-DD-{slug}.md` (slug from decision title)
4. Write via Tauri command: `create_decision_log(content, filename)`
5. Rust: Write to `/decisions`, Git commit (reuse `git_auto_commit` from Phase 1)
6. Frontend: Save metadata to Convex via `api.decisions.create()`
7. Return decision ID + file path to frontend

**Filename Generation**:
- Sanitize title: lowercase, replace spaces with hyphens, remove special chars
- Prefix with ISO date: `2026-02-04-investor-evaluation.md`
- Check for duplicates: append `-2` if exists (reuse Phase 1 pattern)

**Markdown Template**:
```markdown
---
id: {generated-id}
title: {user-provided-title}
category: {template-category}
template: {template-slug}
status: ready
created: {iso-timestamp}
---

# {Title}

## Context
{config.context or "No context provided"}

## Configuration
{key-value pairs from config}

## Experiment Plan
- Personas: {config.persona_count} {config.persona_types}
- Generated from: {list of context files}

## Results
(To be filled after experiment runs)

## Decision
(To be made after reviewing results)

---
Auto-generated by Unheard v2 | Phase 2
```

**Reuse Git Command** (from Phase 1):
- Call existing `git_auto_commit` with files: `["decisions/{filename}"]`
- Commit message: `"Create decision: {title}"`

## Key Context

**Convex Schema** (from epic spec):
- Table `decisions` with fields: clerkUserId, projectId, title, category, templateId, configData, markdownFilePath, status
- Status enum: 'draft' | 'ready' | 'running' | 'completed'
- Indexes: by_user, by_project, by_template

**Error Handling**:
- If Git commit fails: Log error, save to Convex with status='draft', show warning to user
- If Convex fails: Retry with exponential backoff (3 attempts), fallback to localStorage queue

## References

- Git command: Phase 1 spec (`fn-1`, task 5) - `git_auto_commit`
- Markdown format: Epic spec data model section
- Decision schema: `.claude/plans/data-models-spec.md:150-200`
- Task 5: Config data from wizard
## Acceptance
- [ ] Rust command `create_decision_log` accepts: content (String), filename (String), project_path (PathBuf)
- [ ] Command writes file to `/decisions/{filename}`
- [ ] Git commit executed via `git_auto_commit` reuse
- [ ] Commit message format: "Create decision: {title}"
- [ ] Convex schema EXTENDS existing `decisions` table (backward compatible)
- [ ] New optional fields added: `templateId`, `configData`, `markdownFilePath`, `updatedAt`
- [ ] New status values added to enum: 'ready', 'running', 'completed'
- [ ] Existing status values preserved: 'draft', 'analyzing', 'decided'
- [ ] New index added: `by_template` on `templateId`
- [ ] Convex mutation `api.decisions.updateWithLog` updates existing record or creates new
- [ ] TanStack Query hook `useUpdateDecisionWithLog` wraps mutation
- [ ] Decision generator creates valid markdown with YAML frontmatter
- [ ] Filename sanitization: lowercase, hyphens, no special chars
- [ ] Duplicate handling: append `-2`, `-3` if file exists
- [ ] Config data serialized to markdown (key-value list)
- [ ] Context files listed in "Generated from" section
- [ ] Status defaults to 'ready' after creation
- [ ] Error handling: Git failure → Convex marked 'draft'
- [ ] Error handling: Convex failure → localStorage queue with retry
- [ ] Unit tests: Markdown generation, filename sanitization, duplicate handling
- [ ] Test: Valid config produces valid markdown
- [ ] Test: Duplicate filenames increment correctly
- [ ] Test: Git failure doesn't break flow
- [ ] Test: Old decision records still query/render correctly (backward compat)
- [ ] Rust tests: File write, Git commit integration
- [ ] Documentation: Update `docs/developer/external-apis.md` with decision log pattern
- [ ] Documentation: Update `docs/userguide/userguide.md` with "Chat Interface" section
## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
